before_script:
  - virtualenv --python=`which python3` ptp-env
  - source ptp-env/bin/activate
  - pip install -r requirements.txt
  - git submodule sync --recursive
  - git submodule update --init --recursive
  - pip install -r roe-instruments/requirements.txt

after_script:
  - deactivate

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  key: "pip-requirements"
  paths:
    - .cache/pip
    - ptp-env/

stages:
  - test
  - build
  - deploy
  - capture

test:
  script:
    - python -m unittest discover
  tags:
    - ptp

acquisition:
  stage: capture
  script:
    - source /opt/Xilinx/Vivado/2016.4/settings64.sh
    - git clone --recurse-submodules https://gitlab.lasse.ufpa.br/2014-fronthaul/synchronization/roe_vivado.git
    - ./capture.py -vvv --fh-traffic --n-rru-dl 2 --n-rru-ul 2 --n-rru-ptp 2 -p -c -y --roe-path roe_vivado/
  only:
    refs:
      - schedules
      - web
  tags:
    - ptp

.api:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
      allow_failure: true
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - changes:
      - "api/**/*"
      when: on_success
    - when: never
  tags:
    - ptp

api_image:
  extends: .api
  stage: build
  script:
    - docker-compose -f api/docker/docker-compose.yml build

api_test:
  extends: .api
  stage: test
  script:
    - python -m unittest discover -s api

api_deploy:
  extends: .api
  stage: deploy
  before_script:
    - docker-compose -f api/docker/docker-compose.yml down -v
  script:
    - docker-compose -f api/docker/docker-compose.yml up -d
